<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unwrapping Formula 1</title>
    <link rel="icon" href="{{ url_for('static', filename='images/f1icon.jpeg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" id="light-mode-css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/darkmode.css') }}" id="dark-mode-css">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Icons -->
    <script src="https://kit.fontawesome.com/31149d48b0.js" crossorigin="anonymous"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;1,100;1,300;1,400;1,700&family=Open+Sans:wght@300&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation bar -->
    <nav class="navbar navbar-expand-lg fixed-top navbar-dark navbarScroll">
        <div class="container">
            <a class="navbar-brand active" href="{{ url_for('index')}}">Unwrapping Formula 1</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('calendar') }}">Calendar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('data') }}">Data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('news') }}">News</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('learn') }}">Learn</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('contact') }}">Contact</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"></a>
                    </li>
                    <!-- Toggle Switch -->
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-5 pt-5">
        <div class="form-container">
            <form id="predictionForm" class="row">
                <div class="col">
                    <label for="year" class="form-label">Year:</label>
                    <select id="year" name="year" class="form-select" required>
                        <!-- Options will be dynamically added here -->
                    </select>
                </div>
                <div class="col">
                    <label for="event" class="form-label">Event:</label>
                    <select id="event" name="event" class="form-select" required>
                        <!-- Options will be dynamically added here -->
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Predict Winner</button>
            </form>
        </div>
        
        <div class="form-container">
            <div id="predictionResult" class="mt-4">
                <!-- Prediction result will be displayed here -->
            </div>
        </div>

        <!-- Loading logo -->
        <div id="loading" style="display:none;">
            <img src="{{ url_for('static', filename='images/speedfest-automovilismo.gif') }}" alt="Loading..." class="mx-auto d-block">
        </div>
    </div>

    <div class="container mt-5 pt-5">
        <div class="form-container">
            <form id="raceForm" class="row">
                <div class="col">
                    <label for="year" class="form-label">Year:</label>
                    <select id="year" name="year" class="form-select" required>
                        <!-- Options will be dynamically added here -->
                    </select>
                </div>
                <div class="col">
                    <label for="event" class="form-label">Event:</label>
                    <select id="event" name="event" class="form-select" required>
                        <!-- Options will be dynamically added here -->
                    </select>
                </div>
                <div class="col">
                    <label for="drivers" class="form-label">Drivers:</label>
                    <select id="drivers" name="drivers" class="form-select" required>
                        <!-- Options will be dynamically added here -->
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Unwrap!</button>
            </form>
        </div>
        
        <div class="form-container">
            <div id="raceData">
                <img id="raceGraph" src="" alt="Race Graph" style="max-width:100%; display:none;">
                <p id="fastestLap" style="display:none;"></p>
            </div>
        </div>

        <!-- Loading logo -->
        <div id="loading" style="display:none;">
            <img src="{{ url_for('static', filename='images/speedfest-automovilismo.gif') }}" alt="Loading..." class="mx-auto d-block">
        </div>
    </div>

    <script>
        // Function to populate year dropdown
        function populateYears() {
            fetch('/get_years')
                .then(response => response.json())
                .then(years => {
                    const yearDropdown = document.getElementById('year');
                    yearDropdown.innerHTML = '';  // Clear existing options

                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.text = year;
                        yearDropdown.add(option);
                    });

                    // Trigger event to load events for the first year in the list
                    yearDropdown.dispatchEvent(new Event('change'));
                })
                .catch(error => {
                    console.error('Error fetching years:', error);
                });
        }

        // Function to populate event dropdown based on selected year
        function populateEvents(year) {
            fetch(`/get_events?year=${year}`)
                .then(response => response.json())
                .then(events => {
                    const eventDropdown = document.getElementById('event');
                    eventDropdown.innerHTML = '';  // Clear existing options

                    events.forEach(event => {
                        const option = document.createElement('option');
                        option.value = event.round;
                        option.text = event.name;
                        eventDropdown.add(option);
                    });

                    // Trigger event to load drivers for the first event in the list
                    eventDropdown.dispatchEvent(new Event('change'));
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                });
        }

        // Function to populate drivers dropdown based on selected event
        // function populateDrivers(year, round) {
        //     // Show the loading GIF
        //     document.getElementById('loading').style.display = 'flex';

        //     fetch(`/get_drivers?year=${year}&round=${round}`)
        //         .then(response => response.json())
        //         .then(drivers => {
        //             const driversDropdown = document.getElementById('drivers');
        //             driversDropdown.innerHTML = '';  // Clear existing options

        //             drivers.forEach(driver => {
        //                 const option = document.createElement('option');
        //                 option.value = driver.driverId;
        //                 option.text = driver.driverName;
        //                 option.abbrev = driver.driverAbbreviation;
        //                 driversDropdown.add(option);
        //             });
        //         })
        //         .catch(error => {
        //             console.error('Error fetching drivers:', error);
        //         })
        //         .finally(() => {
        //             // Hide the loading GIF
        //             document.getElementById('loading').style.display = 'none';
        //         });
        // }


        // Fetch and populate the list of years when the page loads
        document.addEventListener('DOMContentLoaded', populateYears);

        // Update events dropdown when the year changes
        document.getElementById('year').addEventListener('change', function(event) {
            const year = event.target.value;
            populateEvents(year);
        });

        // Update drivers dropdown when the event changes
        // document.getElementById('event').addEventListener('change', function(event) {
        //     const year = document.getElementById('year').value;
        //     const round = event.target.value;
        //     populateDrivers(year, round);
        // });

        document.getElementById('raceForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const year = document.getElementById('year').value;
            const round = document.getElementById('event').value;
            const selectedDrivers = [...document.getElementById('drivers').selectedOptions].map(option => option.abbrev);
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            const loadingElement = document.getElementById('loading');

            // Show the loading logo
            loadingElement.style.display = 'flex';

            // Assuming selectedDrivers is an array of driver abbreviations
            const driverAbbrv = selectedDrivers[0];  // Assuming you are selecting only one driver

            fetch(`/get_race_data?year=${year}&round=${round}&drivers=${encodeURIComponent(driverAbbrv)}`)
                .then(response => response.json())
                .then(data => {
                    // Hide the loading logo
                    loadingElement.style.display = 'none';

                    const imgElement = document.getElementById('raceGraph');
                    imgElement.src = 'data:image/png;base64,' + data.img_base64;
                    imgElement.style.display = 'block';

                    const fastestLapElement = document.getElementById('fastestLap');
                    // Handle exceptional_laps data if needed
                    fastestLapElement.style.display = 'block';
                })
                .catch(error => {
                    // Hide the loading logo even if there is an error
                    loadingElement.style.display = 'none';
                    console.error('Error fetching race data:', error);
                });
        });


        // Function to convert seconds to 'MM:SS' format
        function seconds_to_minutes(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        document.getElementById('predictionForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const year = document.getElementById('year').value;
            const eventRound = document.getElementById('event').value;  // Ensure this is capturing the correct value
            console.log("Year:", year, "Event Round:", eventRound);
            
            // Show the loading GIF
            document.getElementById('loading').style.display = 'block';

            fetch('/predict_winner', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ year: year, event: eventRound })
            })
            .then(response => response.json())
            .then(data => {
                // Hide the loading GIF
                document.getElementById('loading').style.display = 'none';
                console.log("Predicted Winners Data:", data);
                
                if (data.predicted_winners) {  // Note the use of 'predicted_winners'
                    document.getElementById('predictionResult').innerHTML = `<h2>Predicted Winners: ${data.predicted_winners.join(', ')}</h2>`;
                } else {
                    document.getElementById('predictionResult').innerHTML = `<h2>Error: ${data.error}</h2>`;
                }
            })
            .catch(error => {
                // Hide the loading GIF
                document.getElementById('loading').style.display = 'none';
                console.error('Error fetching prediction:', error);
            });
        });
    </script>
</body>
</html>